var crypto = require('crypto');
var request = require('request');
var constants = require('constants');
var yeepayMerId = '10012465286';
var yeepayMerPrivateKey = 'MIICdQIBADANBgkqhkiG9w0BAQEFAASCAl8wggJbAgEAAoGBAIm6//Fc5U6HE3wtfh2a7txcaAC07UUBb6anIOyPhkVZJ6mTaSlxx0DeH0plivXr9cmj2v9gaxUIFjxEI/FRLKsoU5bAou3I6+4OW0b3B5u9h3KrJPsx//WmpIsnuNLkecWcen5dDaYXpLu7Si+9Uo3KMQFw6B52PkwDlDQmLmJpAgMBAAECgYBfm9ZMAIaVyqK2EwZ3GrQxeFwiEXab7nFJKL9sN/2nakpkJxZbVMZSu17RUEf0iwYmIX7GxHHRObnlwA+LVyQ/75VJvhTFhen3P8vCrIHFIwr61HyWSVxagaiMusL3CoXXf04DHhLDuBvU4qUeaDRtJKnHZ2vS0WqyjfVXasCVuQJBAL7DULB5gIV70Oqs9EcPLrL3cbJ4uL7485eFg2TAcRWuwyxCW+27u+RT5WgN+Qz1okpjVuoduvs9GERvPP4LUOcCQQC41NxbDkuKuaGUnInmLfbeBIIgwKL6J0CNwlaZ80YUirEEz8hsSxLNAY6K//mdsuIm7038y6iywslM6h7fWDgvAkAQxlYbHqQZmNi3OjxE32Xo4O+DlTARwwyQn3H9cxq+oF6TTsaMsjyEiIgczVXAOP1rcy7aaYDexPGUWv/PCymzAkAdc7XFQKri6R+JOcRzjEF5MUi3BVsy90w/CoeYMn6pSUxZ0u5B61iMmEHpfk59RYLp51oK/Tzdd1JyUiAnQLx7AkBUNKsnicFyDDbjx8+y0PpUvUX31Dr5bGw7mYJKWqv/n8+NrsYRZyhdJRRg2VMwFsHCHWW+kcY7LDJTCO8ILV1A';
//yeepayMerPrivateKey = '-----BEGIN RSA PRIVATE KEY-----\n' + yeepayMerPrivateKey + '\n';
//yeepayMerPrivateKey += '-----END RSA PRIVATE KEY-----\n';

var yeepayMerPublicKey = 'MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCJuv/xXOVOhxN8LX4dmu7cXGgAtO1FAW+mpyDsj4ZFWSepk2kpccdA3h9KZYr16/XJo9r/YGsVCBY8RCPxUSyrKFOWwKLtyOvuDltG9webvYdyqyT7Mf/1pqSLJ7jS5HnFnHp+XQ2mF6S7u0ovvVKNyjEBcOgedj5MA5Q0Ji5iaQIDAQAB';
var yeepayPublicKey = 'MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDjE7JQKsNio1vXzv+xm2HxsPJdygymhsnXqiivzl4VSBX9o+DiSE0P2nAFD0uIGjDgfb4Mm1prRKqesC/vecnPzVb4tDEnZuO2ABa3UFXuK71mHMsqdoB5rG9LCo8x0geTnO9mIhPaLjMjIPyN4QraXdHIC0nxMBLzTnJc10oIQQIDAQAB';
var paymentUrl = 'https://www.yeepay.com/app-merchant-proxy/command.action';
//var paymentUrl = 'http://www.yeepay.com/app-merchant-proxy/node';
var debug = true;
function apiUrl(path){
	if ( debug ) return 'http://mobiletest.yeepay.com/testpayapi'+path;
	else return 'https://ok.yeepay.com/payapi' + path;
}

var CRLF = '\n';
function formatKey(key, prefix, postfix)
{
	var fmtKey = prefix + CRLF;
	for ( var i = 0; i < key.length; i+=64 ) {
		fmtKey += key.substr(i, 64) + CRLF;
	}
	fmtKey += postfix;
	return fmtKey;
}
yeepayMerPrivateKey = formatKey(yeepayMerPrivateKey, '-----BEGIN RSA PRIVATE KEY-----', '-----END RSA PRIVATE KEY-----');
//console.log(yeepayMerPrivateKey);

function sign(body) {
	var data = null;
	var keys = [];
	for ( var key in body) {
		if ( key == 'sign' ) continue;
		keys.push(key);
	}
	keys.sort();
	for ( var i = 0; i < keys.length; ++ i ) {
		var key = keys[i];
		var val = body[key];
		if ( data != null ) data += '&';
		else data = '';
		data += key + '=' + val;
	}
	console.log(data);
	var signer = crypto.createSign('RSA');
	signer.update(data, 'utf8');
	var sign = signer.sign(privateKey,'base64');
	return sign;
}

exports.decrypt = function(data){
	/*
	var algorithm = 'RSA';
	var key = yeepayMerPrivateKey;
	var decipher = crypto.createDecipheriv(algorithm, key, '');  
	decipher.setAutoPadding(autoPad);
	var txt = decipher.update(data, 'base64', 'utf8');
	txt += decipher.final(inenc);      
	return txt;
	*/
	//var encrypted = crypto.privateDecrypt(options, 'plaintext');  // encrypted.length == 128
	var buf = new Buffer(data,'base64');//.toString('utf8');
	var key = yeepayMerPrivateKey;
	
	console.log(buf);
	// var decrypted = crypto.privateDecrypt(key, buf);//, constants.RSA_PKCS1_PADDING); 
	var decrypted = crypto.privateDecrypt(key, buf);//, constants.RSA_PKCS1_PADDING); 
	return decrypted;
}

function hmac_md5(arg) {
	var data = '';
	for ( var key in arg ) {
		data += (arg[key]==null?'':arg[key]);
	}
	var hash = crypto.createHmac('md5', yeepayKey).update(data).digest('hex');
	return hash;
}

function pay_request(args, fn) {
	var delivery = args.addr ? 1:0;
	var formData = {
		p0_cmd: 'Buy',
		p1_MerId: yeepayMerId,
		p2_Order: args.orderid,
		p3_Amt: args.amount,
		p4_cur: 'RMB',
		p5_Pid: args.prodid,
		p6_Pcat: args.catid,
		p7_Pdesc: args.desc?args.desc:'',
		p8_Url: args.url,
		p9_SAF: delivery,
	}
	/*
	var data = formData.p0_cmd + formData.p1_MerId + formData.p2_Order +
		formData.p3_Amt + formData.p4_cur + formData.p5_Pid + formData.p6_Pcat +
		formData.p7_Pdesc + formData.p8_Url + formData.p9_SAF; 
	console.log(data);
	var hash = crypto.createHmac('md5', yeepayKey).update(data).digest('hex');
	console.log(hash);
	formData.hmac = hash;
	*/
	formData.hmac = hmac_md5(formData);
	request.post(paymentUrl, {form: formData}, function(err, res, body){
		console.log(err);
		console.log(body);
		fn && fn(err, body);
	});
}

exports.request = pay_request;
